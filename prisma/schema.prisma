generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum SessionStatus {
  PENDING
  COMPLETED
  FAILED
  EXPIRED
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
  REFUNDED
  DISPUTED
  AUTO_DELETED
}

enum SubscriptionStatus {
  ACTIVE
  ON_HOLD
  FAILED
  CANCELLED
  EXPIRED
  GRACE
}

// Plan change status - tracks the state of plan upgrade/downgrade requests
enum PlanChangeStatus {
  PENDING          // Plan change initiated, waiting for payment
  COMPLETED        // Payment succeeded, plan change applied
  PAYMENT_NEEDED   // Payment failed/on-hold, user needs to update payment method
}

enum SessionMode {
  SUBSCRIPTION
  ONE_TIME
}

model UserMapping {
  userUuid           String              @id @default(cuid()) @map("user_uuid")
  email              String              @unique @db.VarChar(255)
  dodoCustomerId     String?             @map("dodo_customer_id")

  // Active subscription ID from DoDo Payments
  // This is the source of truth for the user's current subscription
  subscriptionId     String?             @map("subscription_id") @db.VarChar(100)

  activeTier         String?             @map("active_tier") @db.VarChar(50)
  activeLength       String?             @map("active_length") @db.VarChar(50)
  tierExpiresAt      DateTime?           @map("tier_expires_at")
  subscriptionStatus SubscriptionStatus? @map("subscription_status")

  // Plan change tracking fields
  // Used to track upgrade/downgrade requests and their payment status
  planChangeStatus         PlanChangeStatus? @map("plan_change_status")
  pendingTier              String?           @map("pending_tier") @db.VarChar(50)
  pendingActiveLength      String?           @map("pending_active_length") @db.VarChar(50)
  pendingTierEffectiveDate DateTime?         @map("pending_tier_effective_date")
  pendingChangeType        String?           @map("pending_change_type") @db.VarChar(50)
  pendingProductId         String?           @map("pending_product_id") @db.VarChar(100)
  planChangeInitiatedAt    DateTime?         @map("plan_change_initiated_at")

  createdAt          DateTime            @default(now()) @map("created_at")

  sessions           Session[]
  payments           Payment[]

  @@map("user_mapping")
}

model Session {
  id             String        @id @default(cuid())
  sessionId      String        @unique @map("session_id")

  userUuid       String        @map("user_uuid")
  status         SessionStatus
  mode           SessionMode?
  requestedTier  String?       @map("requested_tier") @db.VarChar(50)

  paymentId      String?       @map("payment_id")
  subscriptionId String?       @map("subscription_id")

  createdDate    DateTime      @default(now()) @map("created_date")
  completedAt    DateTime?     @map("completed_at")
  expiresAt      DateTime?     @map("expires_at")

  user           UserMapping   @relation(fields: [userUuid], references: [userUuid], onDelete: Cascade)

  payments       Payment[]

  @@index([userUuid, createdDate])
  @@map("sessions")
}

model Payment {
  id                 String        @id @default(cuid())

  userUuid           String        @map("user_uuid")
  sessionId          String?       @map("session_id")

  dodoPaymentId      String        @unique @map("dodo_payment_id")
  status             PaymentStatus

  amountCents        Int?          @map("amount_cents") @db.Integer
  currency           String?       @db.Char(3)
  tier               String?       @db.VarChar(50)

  dodoSubscriptionId String?       @map("dodo_subscription_id")
  paymentLink        String?       @map("payment_link")

  createdAt          DateTime      @default(now()) @map("created_at")
  updatedAt          DateTime      @updatedAt @map("updated_at")
  paidAt             DateTime?     @map("paid_at")

  rawJson            Json?         @map("raw_json")

  user               UserMapping   @relation(fields: [userUuid], references: [userUuid], onDelete: Cascade)

  session            Session?      @relation(fields: [sessionId], references: [sessionId], onDelete: SetNull)

  @@index([userUuid, createdAt])
  @@index([sessionId])
  @@map("payments")
}